---
title: "Golang的GC"
date: 2022-02-22T21:31:10+08:00
Description: ""
Tags: [golang, GC, 三色标记]
Categories: [golang]
DisableComments: false
draft: true
---

# GC

编程语言的内存管理方式就两种：自动和手动。像C/C++、Rust这种极致追求性能的语言就是要程序员手动进行内存空间的使用和释放。而像Java、Go等语言就是使用自动的方式进行内存管理，通过内存分配器就行内存分配，通过垃圾收集器进行垃圾回收。

`GC`，全称 `Garbage Collection`，即垃圾回收，就是一种自动内存管理的机制。通过垃圾回收程序员可以专注于写程序，不用考虑内存的释放问题。

## 常见的GC方式

主要包括两种：

- 引用计数GC

  每个对象自身包含一个被引用的计数器，当计数器归零时自动得到回收。因为此方法缺陷较多，在追求高性能时通常不被应用。Python、Objective-C 等均为引用计数式 GC，Python的话是引用计数和隔代回收相结合的方式。

- 追踪式GC

  从根对象出发，根据对象之间的引用信息，一步步推进直到扫描完毕整个堆并确定需要保留的对象，从而回收所有可回收的对象。Go、 Java、V8 对 JavaScript 的实现等均为追踪式 GC。Go的垃圾回收叫做三色标记法。

## STW

即 `Stop the world` 或者 `Start the world`，在GC的一些阶段需要停止所有的 mutator，以确定当前的引用关系，这就导致程序运行过程中会突然停一下，然后再继续运行，所有有GC的语言都无法避免这个问题，也是Go、Java这种语言无法应用于操作系统等极致追求性能的场景下的原因。减少STW的时间，也是所有GC算法要重点优化的对象。Go语言早期版本STW的时间长达几百毫秒，现在已经优化到了半毫秒以下。

## 根对象

根对象在垃圾回收的术语中又叫做根集合，它是垃圾回收器在标记过程时最先检查的对象，包括：

- 全局变量：程序在编译期就能确定的那些存在于程序整个生命周期的变量。
- 执行栈：每个 goroutine 都包含自己的执行栈，这些执行栈上包含栈上的变量及指向分配的堆内存区块的指针。
- 寄存器：寄存器的值可能表示一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块。

根对象都是 mutator 不需要其他对象就可以直接访问到的对象，并且通过根对象可以追踪到其他所有存活的对象

# Go的GC实现

Go采用的是三色标记法进行GC，属于追踪式GC。整个过程分为两个阶段：标记(Mark)和清除(Sweep)，所以也叫做Mark-Sweep垃圾回收算法。



 