<!DOCTYPE html>
<html
  dir="ltr"
  lang="zh-cn"
  data-theme=""
><head>
  <title>
    
      杨海瑞
        |
        CPU的多级缓存和cache line


      


    
  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.81.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta
    name="description"
    content="
      
Per aspera ad astra.
循此苦旅，终抵群星。



    "
  />
  
  
  
  <link
    rel="stylesheet"
    href="/css/main.min.e33d750f1308c1bc80df765e933b806556fb5b7598d040a6a4d3a9019812b993.css"
    integrity="sha256-4z11DxMIwbyA33ZekzuAZVb7W3WY0ECmpNOpAZgSuZM="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.058b31f17db60602cc415fd63b0427e7932fbf35c70d8e341a4c39385f5f6f3e.css"
    integrity="sha256-BYsx8X22BgLMQV/WOwQn55MvvzXHDY40Gkw5OF9fbz4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
    crossorigin="anonymous"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://yanghairui.life/post/cpu%E7%9A%84%E7%BC%93%E5%AD%98%E8%A1%8C/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js"
    integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js"
      integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus="
      crossorigin="anonymous"
    ></script>

  


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CPU的多级缓存和cache line"/>
<meta name="twitter:description" content="CPU的多级缓存 随着计算机进入多核时代，CPU处理速度和内存之间的鸿沟越来越大，因此多核CPU都通过缓存行提高CPU和内存的交互效率。
CPU根据型号不同都会有三层以上的缓存行：
如上图，是一个CPU的典型架构，共有三级缓存
 L1缓存：一般都是分成指令缓存，和数据缓存，分开放。 L2缓存：从L2缓存开始部分指令和数据，L1和L2缓存都是在一个真实的核中的。 L3缓存：从L3开始，往往都是一颗CPU中所有核心共享的。  这三级缓存也是离CPU越远的速度越慢："/>



  


  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "CPU的多级缓存和cache line",
        "headline": "CPU的多级缓存和cache line",
        "alternativeHeadline": "",
        "description": "
      
        CPU的多级缓存 随着计算机进入多核时代，CPU处理速度和内存之间的鸿沟越来越大，因此多核CPU都通过缓存行提高CPU和内存的交互效率。\nCPU根据型号不同都会有三层以上的缓存行：\n如上图，是一个CPU的典型架构，共有三级缓存\n L1缓存：一般都是分成指令缓存，和数据缓存，分开放。 L2缓存：从L2缓存开始部分指令和数据，L1和L2缓存都是在一个真实的核中的。 L3缓存：从L3开始，往往都是一颗CPU中所有核心共享的。  这三级缓存也是离CPU越远的速度越慢：


      


    ",
        "inLanguage": "zh-cn",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/yanghairui.life\/post\/cpu%E7%9A%84%E7%BC%93%E5%AD%98%E8%A1%8C\/"
        },
        "author" : {
            "@type": "Person",
            "name": "杨海瑞"
        },
        "creator" : {
            "@type": "Person",
            "name": "杨海瑞"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "杨海瑞"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "杨海瑞"
        },
        "copyrightYear" : "2021",
        "dateCreated": "2021-08-15T19:34:46.00Z",
        "datePublished": "2021-08-15T19:34:46.00Z",
        "dateModified": "2021-08-15T19:34:46.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "杨海瑞",
            "url": "https://yanghairui.life",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/yanghairui.life\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/yanghairui.life\/post\/cpu%E7%9A%84%E7%BC%93%E5%AD%98%E8%A1%8C\/",
        "wordCount" : "41",
        "genre" : [ 
      
      "golang"

    ],
        "keywords" : [ 
      
      "golang"

    ]
    }
  </script>



</head>
<body>
    <header><div
  class="page-top 
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
  </a>
  <nav>
    <ul class="nav__list" id="navMenu">
      <div class="nav__links">
        
        
          
          <li>
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/post/"
              
              title=""
              >Posts</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/portfolio/"
              
              title=""
              >Portfolio</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/contact/"
              
              title=""
              >Contact</a
            >
          </li>

        
      </div>
      <ul>
        
        
          <li>
            <a class="theme-switch" title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </li>

        
      </ul>
    </ul>
  </nav>
</div>
</header>
    <div class="wrapper">
      <aside><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="logo-title">
      <div class="title">
        <img src="/images/profile5.jpg" alt="profile picture" />
        <h3 title=""><a href="/">Harry Yang&#39;s Website</a></h3>
        <div class="description">
          <p><br />Per aspera ad astra.<br />循此苦旅，终抵群星。<br /></p>
        </div>
      </div>
    </div>
    <ul class="social-links">
      
        <li>
          <a href="https://stackoverflow.com/users/12924262/horace-yang" rel="me" aria-label="StackOverFlow" title="StackOverFlow">
            <i class="fab fa-stack-overflow fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://github.com/harryyann" rel="me" aria-label="GitHub" title="GitHub">
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://www.zhihu.com/people/yang-hai-rui-88" rel="me" aria-label="zhihu" title="zhihu">
            <i class="fab fa-zhihu fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=941811450@qq.com" rel="me" aria-label="e-mail" title="e-mail">
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer--sidebar">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2021-2022

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main>
        <div class="autopagerize_page_element">
          <div class="content">
  <div
    class="post 
      animated fadeInDown

    "
  >
    <div class="post-content">
      
      <div class="post-title">
        <h1>CPU的多级缓存和cache line</h1>
        
          <div class="info">
            <em class="fas fa-calendar-day"></em>
            <span class="date"
              >
                Sun, Aug 15, 2021


              </span
            >
            <em class="fas fa-stopwatch"></em>
            <span class="reading-time">阅读时间 1 分钟</span>
          </div>

        
      </div><h2 id="cpu的多级缓存">CPU的多级缓存</h2>
<p>随着计算机进入多核时代，CPU处理速度和内存之间的鸿沟越来越大，因此多核CPU都通过缓存行提高CPU和内存的交互效率。</p>
<p>CPU根据型号不同都会有三层以上的缓存行：</p>
<p><img src="/images/cacheline/cacheline.png" alt=""></p>
<p>如上图，是一个CPU的典型架构，共有三级缓存</p>
<ul>
<li>L1缓存：一般都是分成<strong>指令缓存</strong>，和<strong>数据缓存</strong>，分开放。</li>
<li>L2缓存：从L2缓存开始部分指令和数据，L1和L2缓存都是在一个真实的核中的。</li>
<li>L3缓存：从L3开始，往往都是一颗CPU中所有核心共享的。</li>
</ul>
<p>这三级缓存也是<strong>离CPU越远的速度越慢</strong>：</p>
<ul>
<li>L1的存取速度：4个CPU时钟周期</li>
<li>L2的存取速度：11个CPU时钟周期</li>
<li>L3的存取速度：39个CPU时钟周期</li>
<li>内存的存取速度：107个时钟周期</li>
</ul>
<p>对于存储空间来说：</p>
<ul>
<li>L1一般64kb</li>
<li>L2一般256kb</li>
<li>L3有2M</li>
</ul>
<h2 id="缓存为什么要设置成三级">缓存为什么要设置成三级？</h2>
<p>主要基于如下考量：</p>
<ul>
<li>缓存级数越多，多个缓存命中反而速度会下降。</li>
<li>由于核心独立缓存的设置，还要考虑多个核心访问同一块数据时的同步问题，明显缓存级数越多，同步过程越复杂</li>
</ul>
<h2 id="cache-line">Cache line</h2>
<p>cpu从内存中捞数据时都是一次性捞多个，而不是一次只捞一个字节，这样效率太低。而cpu每次从内存中加载到的数据行大小就是<strong>缓存行(Cache line)</strong>。主流的大小是<strong>64Bytes</strong>，就是16个32位的整型数据，即如果是int32，那就是一次捞16个。</p>
<p>因为cache line缓存行有固定值，所以<strong>L1、L2、L3都得是cache line的倍数</strong>。</p>
<h2 id="cpu加载内存数据的过程">CPU加载内存数据的过程</h2>
<ol>
<li>CPU从内存中会以cache line的长度获取数据，并根据LRU算法放进L3缓存中，当L3中的数据访问频繁，就会也被加到L2，L1，依次类推。</li>
<li>如果CPU在计算的过程中另外想要拿到的数据刚好在L1中，就直接拿；没有就是L2拿；再没有就去L3拿，再没有就去内存拿，这里是假设了需要被计算的数据往往都是在内存中是连续存储的。</li>
</ol>
<h2 id="缓存的一致性">缓存的一致性</h2>
<p>CPU的写操作分为两种：</p>
<ul>
<li>write back：写操作只写cache，然后再flush到内存。</li>
<li>write through：写操作同时写cache和内存。</li>
</ul>
<p>因为内存和cache的性能鸿沟，所以同时写的话太慢了，一般都会采用write back的方案。通过一些<strong>一致性协议</strong>来保证一个核心修改了自己cache的数据，那么其他的核心的cache如果要用到这块数据也会被修改，保证多个核心访问内存中同一行数据时都是一致的，感觉像是cache不存在一样。</p>
<h2 id="总结">总结</h2>
<p>这方面的知识太过底层，还没有了解的过于深入。其实对于程序员来说，只需要了解到缓存行的存在，并且在写代码时尽量让CPU要访问的数据能命中到缓存行即可，总体来说，就是尽量把CPU可能会连续访问的数据，也存储在内存中靠近的位置。</p>
</div>
    <div class="post-footer">
      <div class="info">
        
          <span class="separator"><a class="category" href="/categories/golang/">golang</a></span>




        

        
          <span class="separator"><a class="tag" href="/tags/golang/">golang</a></span>




        
      </div>
    </div>

    
  </div>


          </div>
        </div>
      </main>
    </div><footer class="footer footer--base">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2021-2022

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script></body>
</html>
